#!/usr/bin/env node

/**
 * Post-build script to generate static HTML files for dynamic routes
 * This is a workaround for ViteSSG v28.2.2's includedRoutes limitations
 */

import fs from 'node:fs'
import { dirname, resolve } from 'node:path'
import { fileURLToPath } from 'node:url'
import { getGuideSlugsSync } from '../plugins/vite-plugin-ssg-dynamic-routes.ts'

const __filename = fileURLToPath(import.meta.url)
const __dirname = dirname(__filename)

async function generateDynamicRoutes() {
  console.log('üîÑ Generating dynamic route HTML files...')

  const distPath = resolve(__dirname, '../dist')
  const guidesPath = resolve(distPath, 'guides')

  if (!fs.existsSync(distPath)) {
    console.warn('‚ö†Ô∏è  Dist directory not found, skipping dynamic route generation')
    return
  }

  // Get guide slugs
  const slugs = getGuideSlugsSync()
  if (slugs.length === 0) {
    console.log('‚ÑπÔ∏è  No dynamic routes to generate')
    return
  }

  console.log(`üìù Found ${slugs.length} dynamic routes to generate:`)
  slugs.forEach(slug => console.log(`   - /guides/${slug}`))

  // Read the template HTML from the dynamic route component
  // We'll use the index.html as a base and modify it
  const indexHtmlPath = resolve(distPath, 'index.html')
  if (!fs.existsSync(indexHtmlPath)) {
    console.warn('‚ö†Ô∏è  index.html not found, cannot generate dynamic routes')
    return
  }

  const baseHtml = fs.readFileSync(indexHtmlPath, 'utf-8')

  // For each slug, create a directory and index.html file
  let generated = 0
  for (const slug of slugs) {
    const slugDir = resolve(guidesPath, slug)
    const slugHtmlPath = resolve(slugDir, 'index.html')

    // Skip if already exists (might have been generated by ViteSSG)
    if (fs.existsSync(slugHtmlPath)) {
      console.log(`‚è≠Ô∏è  Skipping ${slug} (already exists)`)
      continue
    }

    // Create directory
    if (!fs.existsSync(slugDir)) {
      fs.mkdirSync(slugDir, { recursive: true })
    }

    // Generate HTML - replace the base path with the slug route
    // This is a simplified version - in production, you'd want to actually render the component
    const slugHtml = baseHtml
      .replace(/<title>.*?<\/title>/, `<title>${slug} ¬∑ Guides</title>`)
      .replace(/href="\//g, `href="/`)
      .replace(/src="\//g, `src="/`)

    fs.writeFileSync(slugHtmlPath, slugHtml)
    generated++
    console.log(`‚úÖ Generated /guides/${slug}/index.html`)
  }

  if (generated > 0) {
    console.log(`\nüéâ Generated ${generated} dynamic route HTML files`)
  }
  else {
    console.log('\n‚ÑπÔ∏è  All dynamic routes already exist')
  }
}

generateDynamicRoutes().catch(console.error)
